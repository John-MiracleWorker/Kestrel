syntax = "proto3";

package kestrel.brain;

// Brain service handles LLM inference, user management, and data CRUD
service BrainService {
  // Stream chat completions with tool calling support
  rpc StreamChat(ChatRequest) returns (stream ChatResponse);

  // Health check endpoint
  rpc HealthCheck(HealthCheckRequest) returns (HealthCheckResponse);

  // ── User Management ──────────────────────────────────────────
  rpc CreateUser(CreateUserRequest) returns (UserResponse);
  rpc AuthenticateUser(AuthenticateUserRequest) returns (AuthenticateUserResponse);

  // ── Workspace CRUD ───────────────────────────────────────────
  rpc ListWorkspaces(ListWorkspacesRequest) returns (ListWorkspacesResponse);
  rpc CreateWorkspace(CreateWorkspaceRequest) returns (WorkspaceResponse);

  // ── Conversation CRUD ────────────────────────────────────────
  rpc ListConversations(ListConversationsRequest) returns (ListConversationsResponse);
  rpc CreateConversation(CreateConversationRequest) returns (ConversationResponse);
  rpc GetMessages(GetMessagesRequest) returns (GetMessagesResponse);

  // ── Mobile / Sync ────────────────────────────────────────────
  rpc RegisterPushToken(RegisterPushTokenRequest) returns (RegisterPushTokenResponse);
  rpc GetUpdates(GetUpdatesRequest) returns (GetUpdatesResponse);

  // ── Provider Configuration ───────────────────────────────────
  rpc ListProviderConfigs(ListProviderConfigsRequest) returns (ListProviderConfigsResponse);
  rpc SetProviderConfig(SetProviderConfigRequest) returns (SetProviderConfigResponse);
  rpc DeleteProviderConfig(DeleteProviderConfigRequest) returns (DeleteProviderConfigResponse);

  // ── Autonomous Agent ────────────────────────────────────────
  rpc StartTask(StartTaskRequest) returns (stream TaskEvent);
  rpc StreamTaskEvents(StreamTaskEventsRequest) returns (stream TaskEvent);
  rpc ApproveAction(ApproveActionRequest) returns (ApproveActionResponse);
  rpc CancelTask(CancelTaskRequest) returns (CancelTaskResponse);
  rpc ListTasks(ListTasksRequest) returns (ListTasksResponse);
}

// ═══════════════════════════════════════════════════════════════
// Chat messages
// ═══════════════════════════════════════════════════════════════

message ChatRequest {
  string user_id = 1;
  string workspace_id = 2;
  string conversation_id = 3;
  repeated Message messages = 4;
  string provider = 5; // "local", "openai", "anthropic", "google"
  string model = 6;
  map<string, string> parameters = 7; // temperature, max_tokens, etc.
  repeated Tool available_tools = 8;
}

message Message {
  enum Role {
    USER = 0;
    ASSISTANT = 1;
    SYSTEM = 2;
    TOOL = 3;
  }

  Role role = 1;
  string content = 2;
  string tool_call_id = 3;
  repeated ToolCall tool_calls = 4;
}

message Tool {
  string name = 1;
  string description = 2;
  string parameters_schema = 3; // JSON schema as string
}

message ToolCall {
  string id = 1;
  string name = 2;
  string arguments = 3; // JSON string
}

message ChatResponse {
  enum ChunkType {
    CONTENT_DELTA = 0;
    TOOL_CALL = 1;
    DONE = 2;
    ERROR = 3;
  }

  ChunkType type = 1;
  string content_delta = 2;
  ToolCall tool_call = 3;
  string error_message = 4;
  map<string, string> metadata = 5;
}

// ═══════════════════════════════════════════════════════════════
// Health check
// ═══════════════════════════════════════════════════════════════

message HealthCheckRequest {}

message HealthCheckResponse {
  bool healthy = 1;
  string version = 2;
  map<string, string> status = 3;
}

// ═══════════════════════════════════════════════════════════════
// User Management
// ═══════════════════════════════════════════════════════════════

message CreateUserRequest {
  string email = 1;
  string password = 2;
  string display_name = 3;
}

message UserResponse {
  string id = 1;
  string email = 2;
  string display_name = 3;
}

message AuthenticateUserRequest {
  string email = 1;
  string password = 2;
}

message WorkspaceMembership {
  string id = 1;
  string role = 2;
}

message AuthenticateUserResponse {
  string id = 1;
  string email = 2;
  string display_name = 3;
  repeated WorkspaceMembership workspaces = 4;
}

// ═══════════════════════════════════════════════════════════════
// Workspace CRUD
// ═══════════════════════════════════════════════════════════════

message ListWorkspacesRequest {
  string user_id = 1;
}

message WorkspaceResponse {
  string id = 1;
  string name = 2;
  string role = 3;
  string created_at = 4;
}

message ListWorkspacesResponse {
  repeated WorkspaceResponse workspaces = 1;
}

message CreateWorkspaceRequest {
  string user_id = 1;
  string name = 2;
}

// ═══════════════════════════════════════════════════════════════
// Conversation CRUD
// ═══════════════════════════════════════════════════════════════

message ListConversationsRequest {
  string user_id = 1;
  string workspace_id = 2;
}

message ConversationResponse {
  string id = 1;
  string title = 2;
  string created_at = 3;
  string updated_at = 4;
}

message ListConversationsResponse {
  repeated ConversationResponse conversations = 1;
}

message CreateConversationRequest {
  string user_id = 1;
  string workspace_id = 2;
}

message GetMessagesRequest {
  string user_id = 1;
  string workspace_id = 2;
  string conversation_id = 3;
}

message MessageResponse {
  string id = 1;
  string role = 2;
  string content = 3;
  string created_at = 4;
}

message GetMessagesResponse {
  repeated MessageResponse messages = 1;
}

// ═══════════════════════════════════════════════════════════════
// Mobile / Sync
// ═══════════════════════════════════════════════════════════════

message RegisterPushTokenRequest {
  string user_id = 1;
  string device_token = 2;
  string platform = 3; // "ios", "android", "web"
}

message RegisterPushTokenResponse {
  bool success = 1;
}

message GetUpdatesRequest {
  string user_id = 1;
  string since = 2; // ISO timestamp
}

message GetUpdatesResponse {
  repeated MessageResponse messages = 1;
  repeated ConversationResponse conversations = 2;
}

// ═══════════════════════════════════════════════════════════════
// Provider Configuration
// ═══════════════════════════════════════════════════════════════

message ProviderConfig {
  string workspace_id = 1;
  string provider = 2;
  string model = 3;
  float temperature = 4;
  int32 max_tokens = 5;
  string system_prompt = 6;
  bool rag_enabled = 7;
  int32 rag_top_k = 8;
  float rag_min_similarity = 9;
  bool is_default = 10;
  string api_key_encrypted = 11;
  string created_at = 12;
  string updated_at = 13;
}

message ListProviderConfigsRequest {
  string workspace_id = 1;
}

message ListProviderConfigsResponse {
  repeated ProviderConfig configs = 1;
}

message SetProviderConfigRequest {
  string workspace_id = 1;
  string provider = 2;
  string model = 3;
  float temperature = 4;
  int32 max_tokens = 5;
  string system_prompt = 6;
  bool rag_enabled = 7;
  int32 rag_top_k = 8;
  float rag_min_similarity = 9;
  bool is_default = 10;
  string api_key_encrypted = 11; // Optional: only if updating key
}

message SetProviderConfigResponse {
  ProviderConfig config = 1;
}

message DeleteProviderConfigRequest {
  string workspace_id = 1;
  string provider = 2;
}

message DeleteProviderConfigResponse {
  bool success = 1;
}

// ═══════════════════════════════════════════════════════════════
// Autonomous Agent
// ═══════════════════════════════════════════════════════════════

message StartTaskRequest {
  string user_id = 1;
  string workspace_id = 2;
  string goal = 3;                    // Natural language goal
  string conversation_id = 4;        // Optional: link to conversation
  GuardrailConfig guardrails = 5;    // Optional: custom limits
}

message GuardrailConfig {
  int32 max_iterations = 1;          // Default: 25
  int32 max_tool_calls = 2;          // Default: 50
  int32 max_tokens = 3;              // Default: 100000
  int32 max_wall_time_seconds = 4;   // Default: 600
  string auto_approve_risk = 5;      // "low", "medium", "high", "critical"
  repeated string blocked_patterns = 6;
  repeated string require_approval_tools = 7;
}

message TaskEvent {
  enum EventType {
    PLAN_CREATED = 0;
    STEP_STARTED = 1;
    TOOL_CALLED = 2;
    TOOL_RESULT = 3;
    STEP_COMPLETE = 4;
    APPROVAL_NEEDED = 5;
    THINKING = 6;
    TASK_COMPLETE = 7;
    TASK_FAILED = 8;
    TASK_PAUSED = 9;
  }

  EventType type = 1;
  string task_id = 2;
  string step_id = 3;
  string content = 4;               // Thinking text, result, error
  string tool_name = 5;
  string tool_args = 6;             // JSON string
  string tool_result = 7;
  string approval_id = 8;
  map<string, string> progress = 9; // current_step, total_steps, etc.
}

message StreamTaskEventsRequest {
  string task_id = 1;
  string user_id = 2;
}

message ApproveActionRequest {
  string approval_id = 1;
  string user_id = 2;
  bool approved = 3;                // true = approve, false = deny
}

message ApproveActionResponse {
  bool success = 1;
  string error = 2;
}

message CancelTaskRequest {
  string task_id = 1;
  string user_id = 2;
}

message CancelTaskResponse {
  bool success = 1;
}

message ListTasksRequest {
  string user_id = 1;
  string workspace_id = 2;
  string status = 3;                // Optional filter: "executing", "complete", etc.
}

message TaskSummary {
  string id = 1;
  string goal = 2;
  string status = 3;
  int32 iterations = 4;
  int32 tool_calls = 5;
  string result = 6;
  string error = 7;
  string created_at = 8;
  string completed_at = 9;
}

message ListTasksResponse {
  repeated TaskSummary tasks = 1;
}
